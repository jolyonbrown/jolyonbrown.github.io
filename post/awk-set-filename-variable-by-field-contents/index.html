<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Awk: Set Output Filename Variable via Field Contents</title>

  <meta name="author" content="" />
  
  

  <meta name="generator" content="Hugo 0.55.6" />

  <link rel="alternate" href="https://jolyonbrown.com/index.xml" type="application/rss+xml" title="Jolyon Brown">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://jolyonbrown.com/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://jolyonbrown.com/css/main.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://jolyonbrown.com/css/pygment_highlights.css" />
  
  
  <meta property="og:title" content="Awk: Set Output Filename Variable via Field Contents" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/post/awk-set-filename-variable-by-field-contents//" />
  <meta property="og:image" content="" />

  <script src="//load.sumome.com/" data-sumo-site-id="4af41100d66c8400ba126e006ba91100136040008d2ab300bada1b00bd22ef00" async="async"></script>
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://jolyonbrown.com/">Jolyon Brown</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
          <a title="Home" href="/">Home</a>
  	      </li>
  	    
      
        
          <li>
          <a title="All posts" href="/posts">All posts</a>
  	      </li>
  	    
      
        
          <li>
          <a title="About" href="/page/about">About</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Tags" href="/tags">Tags</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
	  </div>
	</div>

  </div>
</nav>


    <div role="main" class="container main-content">

      
        





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Awk: Set Output Filename Variable via Field Contents</h1>
      
      
      
      <span class="post-meta">Posted on September 10, 2014</span>
      
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
          <p>I suspect the title of this post would win a prize for the worst on the internet. Oh well. On a new contract at the moment working with people from various backgrounds in IT. One of my new co-workers had a text file containing a dump of a postgres database and wanted to extract all the CREATE FUNCTION statements out of it for analysis; could I take a look as resident Linux guy? There was a lot of other stuff in the file, the functions were of varying length and split over a number of lines and had a couple of differing closing parameters. Awk was obviously the go-to tool here, but the request had the added complication that each function had to be stored in a seperate output file, named after the function that was being extracted into it. While matching between two patterns is easy in awk, I had some struggle finding out how to dump lines into a file whose name was set by a variable which was in turn set by the contents of a field. Google failed me so I’ve posted this in the hope it helps some other poor soul and saves them the syntax errors I endured figuring it out.</p>

<p>A CREATE FUNCTION statement looked like this in the file in question:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">CREATE FUNCTION function_name(variable name type) RETURNS
another_variable
LANGUAGE plpgsql
AS $$
    DECLARE
    ...
    &lt;Various SQL statements&gt;
    ...
END;
$$;</pre></div>
<p>The $$; sequence was replaced by $_$ in other functions for some reason (personal preference of whoever wrote it I guess). The desired name for the output file would be ‘function_name’ in this example.</p>

<p>Here’s the (one liner of course) awk statement I ended up using (you may need to scroll to see the whole thing):</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">awk -F&#39; |[(]&#39; &#39;/CREATE FUNCTION/ {p=1;name=$3}; p {print &gt; name}; /\$\$;|\$_\$;/ {p=0;close(name)}; &#39; INPUT.sql</pre></div>
<p>A brief explanation. The parameters to the -F set the awk field delimiter to either (thanks to the | symbol) a space ’ ’ or open bracket <a href="the square brackets being used to escape the regular one">(</a>.</p>

<p>The /CREATE FUNCTION/ is the first pattern to match against. When awk sees that, it sets variable p to 1, and sets the variable name to field 3 of that line, which in our case is the name of the function up to the (.</p>

<p>The p {print &gt; name}; statement prints out lines if p equals 1 (the default action for awk). It also dumps any printed lines into a file, using the name variable as the filename. The position of the ‘p’ in the middle of this statement means that the whole desired range is printed, including the two patterns being matched against.</p>

<p>The (escaped) $$; sequence is an end pattern to match on, as is the alternative (signified by the | ) $_$; (also escaped). Once either of these is seen, awk sets p to zero, and closes the file. Failing to close the file results in an error relating to too many files being open.</p>

<p>The INPUT.sql is merely the file awk reads from.</p>

<p>The result – a long manual edit avoided and many small files, correctly named and containing the correct statements. Good old awk.</p>

<p><sup><em>Update (2017). I&rsquo;ve moved this page from my old blog (the only surviving post!) as it occasionally gets hits for very obscure awk related searches. Hopefully has helped someone out in the last few years..</em></sup></p>

      </article>

      <ul class="pager blog-pager">
        
        
        <li class="next">
          <a href="https://jolyonbrown.com/post/a-social-media-sabbatical/" data-toggle="tooltip" data-placement="top" title="A social media sabbatical">Next Post &rarr;</a>
        </li>
        
      </ul>

      

    </div>
  </div>
</div>

      

    </div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
		      
		      
		      
	    	  
          
          

    		  <li>
      			<a href="https://jolyonbrown.com/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="copyright text-muted">
    		  
    		  &nbsp;&bull;&nbsp;
    		  2018
    		  
    		  
    		  &nbsp;&bull;&nbsp;
    		  <a href="https://jolyonbrown.com/">Jolyon Brown</a>
    		  
  	    </p>
  	        
    		<p class="theme-by text-muted">
    		  Theme by
    		  <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    		</p>
      </div>
    </div>
  </div>
</footer>

<script src="https://jolyonbrown.com/js/jquery-1.11.2.min.js"></script>
<script src="https://jolyonbrown.com/js/bootstrap.min.js"></script>
<script src="https://jolyonbrown.com/js/main.js"></script>



  </body>
</html>
